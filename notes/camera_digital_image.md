# 摄像头/数字图像处理的基本理论知识

### 1. 摄像头数据流程

摄像头本质上是把光信号转化为数字信号的装置，摄像头的信号处理流程见下图：

外界光线进入摄像头->图像传感器将光信号转化为数字信号->DSP 对数字信号进行处理（滤波，增强，白平衡等）并且生成图像格式数据->利用通讯接口传递给应用层使用。

![在这里插入图片描述](.\camera_digital_image.assets\f71ea7b6b406943417db4700b63c64e2.png)

### 2.图像的数据表达方式

由1可知，图像在使用的过程中会有 **采样**->**传输**->**表达**三个阶段，这三个阶段中都涉及到图像的表达，即像素的表达方式。

原理上，任何色彩都能用红绿蓝三个颜色表示，所以会有RGB 这种色彩的表达方式。

由于有新的研究发现，并且一张图像能够用YUV的格式表示出来，其中Y 表示明亮度， U V变量则分别表示色度和饱和度。下图是一张图片的Y U V三个分量图片。

<img src=".\camera_digital_image.assets\320px-Barn-yuv.png" width=30%>

并且RGB 和YUV还是可以相互转化的，见下方公式：

```c
/*RGB 转 YUV */
Y = 0.299*R + 0.587*G + 0.114*B
U = -0.169*R -0.331*G + 0.5*B + 128
V = 0.5*R - 0.419*G - 0.081*B +128
    
/* YUV 转 RGB */
R = 1.164(Y - 16) + 1.596(V -128)
G = 1.164(Y - 16) - 0.813(V -128) - 0.391(U - 128)
B = 1.164(Y - 16) + 2.018(U - 128)
```

对于RGB，常用的像素点表达类型有RGB565、RGB888、ARG8B888，分别需要16 24  32bit。

对于YUV常用的采样有YUV444 YUV422 YUV420，传输中平均需要：24bit 16bit 12bit，由此可见，在相同的色彩需求下，YUV的**传输**方式会比RGB数据流的表达方式节省更多的带宽。

----

#### 2.1 采样

RGB的采样即三个色素通道都用对应的bit数采样即可，这里重点介绍YUV的采样。**对于下图这样的图片[实际值]**，其外界光线传入到传感器的数据为：

```c
[Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]
[Y4 U4 V4] [Y5 U5 V5] [Y6 U6 V6] [Y7 U7 V7]
```

![在这里插入图片描述](.\camera_digital_image.assets\97b66c2c801126e6becd8432edbe91aa.png)

对于不同YUV格式的采样分别表达如下：

* YUV444：采样的时候每个元素的YUV通道都会进行采样，即为

```c
[Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]
[Y4 U4 V4] [Y5 U5 V5] [Y6 U6 V6] [Y7 U7 V7]
```

* YUV422：YUV采样的分量比值为4:2:2，即UV分量隔一个图采样一个。

```c
[Y0 U0 xx] [Y1 xx V1] [Y2 U2 xx] [Y3 xx V3]
[Y4 U4 xx] [Y5 xx V5] [Y6 U6 xx] [Y7 xx V7]
```

* YUV420：YUV采样的分量比值为4:1:1，即4个像素点里面只采样一个U 一个V。在实际的扫描采样的过程中，就是第一行是4:2:0,第二行就是4:0:2 这样就能实现每四个像素点都有一个UV分量。

```c
[Y0 U0 XX] [Y1 XX XX] [Y2 U2 XX] [Y3 XX XX]
[Y4 XX V4] [Y5 XX XX] [Y6 XX V6] [Y7 XX XX]
```

#### 2.2 传输和存储 码流

YUV数据图像格式的传输码流和存储主要分为两种方式：

* YUV 的数据按像素点（pixel）顺序传输：比如对于YUV422 就有YUYV的数据码流方式：

  ```c
  [Y0 U0 Y1 V1 Y2 U2 Y3 V3 Y4 U4 Y5 V5 Y6 U6 Y7  V7]
  ```

* 不管数据的采样方式，就按采样到的数据分量依次排布，比如对于YUV420有下面的码流方式：

  ```c
  [Y0 Y1 Y2 Y3 Y4 Y5 Y6 Y7 U0 U2 V4 V6]
  ```

#### 2.3 图像展现

当传输过来的数据存储到内存中后，最后的图片数据还是需要三个YUV的分量才能显示出原有的颜色，于是对于YUV422、YUV420 这种采样不完整的数据流就会以每四个为组的方式**共用UV分量**来展现颜色。

* YUV444：每一个像素点的YUV分量都被采样了，也都能再被显示出来。

  ```c
  [Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]
  [Y4 U4 V4] [Y5 U5 V5] [Y6 U6 V6] [Y7 U7 V7]
  ```

* YUV422：由于是隔点采样UV，所以相邻的像素点共用UV分量

  ```c
  [Y0 U0 V1] [Y1 U0 V1] [Y2 U2 V3] [Y3 U2 V3]
  [Y4 U4 V5] [Y5 U4 V5] [Y6 U6 V7] [Y7 U6 V7]
  ```

* YUV420：由于是隔点采样U/V，隔行采样U/V，所以隔点和隔行共用一个UV.

  ```c
  [Y0 U0 V4] [Y1 U0 V4] [Y2 U2 v6] [Y3 U2 v6]
  [Y4 U0 V4] [Y5 U0 V4] [Y6 U2 v6] [Y7 U2 v6]
  ```

#### 2.4 数据的大小比较

现在有一张1920 x 1080 的1K分辨率的图像，比对不同格式下的采样存储图的大小。有1920 x 1080的分辨率说明有1920 x 1080个像素点。

```c
RGB888: （1920*1080*3*8bit）/8/1024/1024 = 5.93M
YUV444：（1920*1080*3*8bit）/8/1024/1024 = 5.93M
YUV422： (1920*1080*1+1920*1080*0.5*2channel)*8/8/1024/1024 = 3.95M
YUV420: (1920*1080*1+ 1920*1080*0.25*2channel)*8/8/1024/1024 = 2.96M 
```

可以看到YUV420 的存储时RGB888的 50%，甚至YUV422也是RGB888的2/3。

---

###  3.摄像头3A算法

* 自动对焦（AF）：用相机上的光电传感器将物体反射的光接受，根据相机内部芯片的计算与处理，最后由电动对焦装置对焦

* 自动曝光(AE)：在程序自动曝光方式中，照相机能根据测光系统所测得的被摄画面的曝光值，按照厂家生产时所设定的快门及光圈曝光组合，自动地设定快门速度和光圈值，目的应该是让图片能有较好的亮度和光色。

* 自动白平衡（AWB）：白平衡的意思是白色的平衡。白平衡是描述显示器中红、绿、蓝三基色混合生成后白色精确度的一项指标，目的是解决物体反射的颜色会被光线照射之后失真的现象。

引用：https://blog.csdn.net/Scott_S/article/details/118525159